{% extends "basecert.html" %}

{% block title %}CERTIFICATE OF APPEARANCE{% endblock %}

{% block credentials %}
    <h3>ENTER CREDENTIALS</h3>
    <form>
        <label>Station:</label>
        <input type="text" id="station" placeholder="Enter Station" oninput="updatePreview()">
        <label>Purpose:</label>
        <input type="text" id="purpose" placeholder="Enter Purpose" oninput="updatePreview()">
        <label>Duration:</label>
        <input type="date" id="duration" placeholder="Enter Duration" oninput="updatePreview()">
        <label>Personnel:</label>
        <textarea id="personnel" placeholder="Enter Personnel | One Per Line" oninput="updatePreview()"></textarea>
        <label>Date Issued:</label>
        <input type="date" id="dateIssued" oninput="updatePreview()">
        <br>
        <button id="submit">Submit</button>
    </form>

    <br>

    <a href="{% url 'dashboard' %}"><button>Go Back</button></a>
    <button id="clear-form">Clear Form</button> 
    <a href="{% url 'home' %}"><button>Logout</button></a>
{% endblock %}

{% block preview %}
    <h3 id="preview-header">CERTIFICATE OF APPEARANCE</h3>
    <p style="text-indent: 80px;">THIS IS TO CERTIFY that the following personnel of 
        <strong><span id="preview-station">________</span></strong> appeared to this office purposely to 
        <strong><span id="preview-purpose">________</span></strong> on
        <strong><span id="preview-duration">________</span></strong> at 
        <strong>Cagayan de Oro Fire District, Captain Vicente Roa St., Cagayan de Oro City</strong>, to wit:
    </p>
    <strong><p id="preview-personnel">[Enter Personnel]</p></strong>
    <p style="text-indent: 80px;">This certification is being issued for whatever purpose it may serve.</p>
    <p style="text-indent: 80px;">Issued this <strong><span id="preview-dateIssued">________</span></strong> at the Office of the District Fire Marshal,
        Cagayan de Oro Fire District, Captain Vicente Roa St., Cagayan de Oro City.
    </p>
    <div class="signature">
        <strong><p>District Fire Marshal</p></strong>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // DATE
    function formatDate(inputDate, withSuffix = false) {
        if (!inputDate) return "________";

        let date = new Date(inputDate);
        let day = date.getDate();
        let month = date.toLocaleString("en-GB", { month: "long" });
        let year = date.getFullYear();

        if (withSuffix) {
            function getOrdinalSuffix(n) {
                if (n > 3 && n < 21) return "th"; // Covers 11th to 20th
                switch (n % 10) {
                    case 1: return "st";
                    case 2: return "nd";
                    case 3: return "rd";
                    default: return "th";
                }
            }
            return `${day}${getOrdinalSuffix(day)} of ${month} ${year}`;
        } else {
            return `${day} ${month} ${year}`;
        }
    }

    // PREVIEW FUNCTION
    function updatePreview() {
        document.getElementById("preview-station").textContent = document.getElementById("station").value || "________";
        document.getElementById("preview-purpose").textContent = document.getElementById("purpose").value || "________";
        document.getElementById("preview-personnel").innerHTML = document.getElementById("personnel").value.replace(/\n/g, "<br>") || "[Enter Personnel]";
        document.getElementById("preview-duration").textContent = formatDate(document.getElementById("duration").value, false);
        document.getElementById("preview-dateIssued").textContent = formatDate(document.getElementById("dateIssued").value, true);
    }

    // SUBMIT TO PRINT
    document.getElementById("submit").addEventListener("click", function(event) {
        event.preventDefault();
        localStorage.setItem("certType", "app");
        localStorage.setItem("station", document.getElementById("station").value);
        localStorage.setItem("purpose", document.getElementById("purpose").value);
        localStorage.setItem("duration", document.getElementById("duration").value);
        localStorage.setItem("personnel", document.getElementById("personnel").value);
        localStorage.setItem("dateIssued", document.getElementById("dateIssued").value);
        localStorage.setItem("previousPage", "certapp"); 

        window.location.href = "{% url 'print' %}";
    });

    // Populate form data from localStorage
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("station").value = localStorage.getItem("station") || "";
        document.getElementById("purpose").value = localStorage.getItem("purpose") || "";
        document.getElementById("personnel").value = localStorage.getItem("personnel") || "";
        document.getElementById("duration").value = localStorage.getItem("duration") || "";
        document.getElementById("dateIssued").value = localStorage.getItem("dateIssued") || "";
        updatePreview();
    });

    // CLEAR FORM FUNCTION
    document.getElementById("clear-form").addEventListener("click", function() {
        // Clear form fields
        document.getElementById("station").value = "";
        document.getElementById("purpose").value = "";
        document.getElementById("personnel").value = "";
        document.getElementById("duration").value = "";
        document.getElementById("dateIssued").value = "";
        updatePreview();

        // Clear localStorage entries
        localStorage.removeItem("station");
        localStorage.removeItem("purpose");
        localStorage.removeItem("personnel");
        localStorage.removeItem("duration");
        localStorage.removeItem("dateIssued");
    });
</script>
{% endblock %}